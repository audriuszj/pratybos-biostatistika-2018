function TraceManager(graphDiv,highlight){this.gd=graphDiv,this.origData=JSON.parse(JSON.stringify(graphDiv.data)),this.origOpacity=[];for(var i=0;i<this.origData.length;i++)this.origOpacity[i]=this.origData[i].opacity||1;this.groupSelections={},this.highlight=highlight}function getMatchFunc(trace){return trace._isNestedKey?findNestedMatches:trace._isSimpleKey?findSimpleMatches:findMatches}function findMatches(haystack,needleSet){var matches=[];return haystack.forEach(function(obj,i){(null===obj||needleSet.indexOf(obj)>=0)&&matches.push(i)}),matches}function findSimpleMatches(haystack,needleSet){var match=haystack.every(function(val){return null===val||needleSet.indexOf(val)>=0});return match?[0]:[]}function findNestedMatches(haystack,needleSet){for(var matches=[],i=0;i<haystack.length;i++){var hay=haystack[i],match=hay.every(function(val){return null===val||needleSet.indexOf(val)>=0});match&&matches.push(i)}return matches}function isPlainObject(obj){return"[object Object]"===Object.prototype.toString.call(obj)&&Object.getPrototypeOf(obj)===Object.prototype}function subsetArrayAttrs(obj,indices){var newObj={};return Object.keys(obj).forEach(function(k){var val=obj[k];newObj[k]="_"===k.charAt(0)?val:"transforms"===k&&Array.isArray(val)?val.map(function(transform){return subsetArrayAttrs(transform,indices)}):"colorscale"===k&&Array.isArray(val)?val:isPlainObject(val)?subsetArrayAttrs(val,indices):Array.isArray(val)?subsetArray(val,indices):val}),newObj}function subsetArray(arr,indices){for(var result=[],i=0;i<indices.length;i++)result.push(arr[indices[i]]);return result}function removeBrush(el){for(var outlines=el.querySelectorAll(".select-outline"),i=0;i<outlines.length;i++)outlines[i].remove()}HTMLWidgets.widget({name:"plotly",type:"output",initialize:function(){return{}},resize:function(el,width,height,instance){if(instance.autosize){var width=instance.width||width,height=instance.height||height;Plotly.relayout(el.id,{width:width,height:height})}},renderValue:function(el,x,instance){function eventDataWithKey(eventData){return void 0!==eventData&&eventData.hasOwnProperty("points")?eventData.points.map(function(pt){var obj={curveNumber:pt.curveNumber,pointNumber:pt.pointNumber,x:pt.x,y:pt.y},gd=document.getElementById(el.id),trace=gd.data[pt.curveNumber];if(trace._isSimpleKey){obj.key=trace.key;var attrsToAttach=["z"]}else var attrsToAttach=["key","z"];for(var i=0;i<attrsToAttach.length;i++){var attr=trace[attrsToAttach[i]];Array.isArray(attr)&&(obj[attrsToAttach[i]]="number"==typeof pt.pointNumber?attr[pt.pointNumber]:attr[pt.pointNumber[0]][pt.pointNumber[1]])}return obj}):null}function pointsToKeys(points){for(var keysBySet={},i=0;i<points.length;i++){var trace=graphDiv.data[points[i].curveNumber];if(trace.key&&trace.set){keysBySet[trace.set]=keysBySet[trace.set]||{value:[],_isSimpleKey:trace._isSimpleKey};var pts=points[i].pointNumber||points[i].pointNumbers,key=trace._isSimpleKey?trace.key:Array.isArray(pts)?pts.map(function(idx){return trace.key[idx]}):trace.key[pts],keyFlat=trace._isNestedKey?[].concat.apply([],key):key;keysBySet[trace.set].value=keysBySet[trace.set].value.concat(keyFlat)}}return keysBySet}crosstalk["var"]("plotlyCrosstalkOpts").set(x.highlight);if("undefined"!=typeof window){window.PLOTLYENV=window.PLOTLYENV||{},window.PLOTLYENV.BASE_URL=x.base_url;var persistOnShift=function(e){e||window.event,e.shiftKey?(x.highlight.persistent=!0,x.highlight.persistentShift=!0):(x.highlight.persistent=!1,x.highlight.persistentShift=!1)};x.highlight.persistent||(window.onmousemove=persistOnShift)}var graphDiv=document.getElementById(el.id);if(HTMLWidgets.addPostRenderHandler(function(){for(var modebars=document.querySelectorAll(".js-plotly-plot .plotly .modebar"),i=0;i<modebars.length;i++)modebars[i].style.zIndex=1}),x.selectize||x.highlight.dynamic&&!instance.plotly){var flex=document.createElement("div");if(flex["class"]="plotly-crosstalk-control-panel",flex.style="display: flex; flex-wrap: wrap",x.highlight.dynamic){var pickerDiv=document.createElement("div"),pickerInput=document.createElement("input");pickerInput.id=el.id+"-colourpicker",pickerInput.placeholder="asdasd";var pickerLabel=document.createElement("label");pickerLabel["for"]=pickerInput.id,pickerLabel.innerHTML="Brush color&nbsp;&nbsp;",pickerDiv.appendChild(pickerLabel),pickerDiv.appendChild(pickerInput),flex.appendChild(pickerDiv)}if(x.selectize)for(var ids=Object.keys(x.selectize),i=0;i<ids.length;i++){var container=document.createElement("div");container.id=ids[i],container.style="width: 80%; height: 10%",container["class"]="form-group crosstalk-input-plotly-highlight";var label=document.createElement("label");label["for"]=ids[i],label.innerHTML=x.selectize[ids[i]].group,label["class"]="control-label";var selectDiv=document.createElement("div"),select=document.createElement("select");select.multiple=!0,selectDiv.appendChild(select),container.appendChild(label),container.appendChild(selectDiv),flex.appendChild(container)}if(graphDiv.parentElement.insertBefore(flex,graphDiv),x.highlight.dynamic){var picker=$("#"+pickerInput.id),colors=x.highlight.color||[],opts={value:colors[0],showColour:"both",palette:"limited",allowedCols:colors.join(" "),width:"20%",height:"10%"};picker.colourpicker({changeDelay:0}),picker.colourpicker("settings",opts),picker.colourpicker("value",opts.value);for(var grps=x.highlight.ctGroups||[],i=0;i<grps.length;i++)crosstalk.group(grps[i])["var"]("plotlySelectionColour").set(picker.colourpicker("value"));picker.on("change",function(){for(var i=0;i<grps.length;i++)crosstalk.group(grps[i])["var"]("plotlySelectionColour").set(picker.colourpicker("value"))})}}if(x.config=x.config||{},x.config.cloud||(x.config.modeBarButtonsToRemove=x.config.modeBarButtonsToRemove||[],x.config.modeBarButtonsToRemove.push("sendDataToCloud")),instance.plotly){Plotly.purge(graphDiv),graphDiv.data=void 0,graphDiv.layout=void 0;var plot=Plotly.plot(graphDiv,x)}else{var plot=Plotly.plot(graphDiv,x);instance.plotly=!0,instance.autosize=x.layout.autosize||!0,instance.width=x.layout.width,instance.height=x.layout.height}plot.then(function(){HTMLWidgets.shinyMode&&Shiny.addCustomMessageHandler("plotly-calls",function(msg){var gd=document.getElementById(msg.id);if(!gd)throw new Error("Couldn't find plotly graph with id: "+msg.id);if(!Plotly[msg.method])throw new Error("Unknown method "+msg.method);var args=[gd].concat(msg.args);Plotly[msg.method].apply(null,args)});for(var mapboxIDs=graphDiv._fullLayout._subplots.mapbox,i=0;i<mapboxIDs.length;i++){var id=mapboxIDs[i],mapOpts=x.layout[id]||{},args=mapOpts._fitBounds||{};if(args){var mapObj=graphDiv._fullLayout[id]._subplot.map;mapObj.fitBounds(args.bounds,args.options)}}}),HTMLWidgets.shinyMode&&(graphDiv.on("plotly_relayout",function(d){Shiny.onInputChange(".clientValue-plotly_relayout-"+x.source,JSON.stringify(d))}),graphDiv.on("plotly_hover",function(d){Shiny.onInputChange(".clientValue-plotly_hover-"+x.source,JSON.stringify(eventDataWithKey(d)))}),graphDiv.on("plotly_click",function(d){Shiny.onInputChange(".clientValue-plotly_click-"+x.source,JSON.stringify(eventDataWithKey(d)))}),graphDiv.on("plotly_selected",function(d){Shiny.onInputChange(".clientValue-plotly_selected-"+x.source,JSON.stringify(eventDataWithKey(d)))}),graphDiv.on("plotly_unhover",function(){Shiny.onInputChange(".clientValue-plotly_hover-"+x.source,null)}),graphDiv.on("plotly_doubleclick",function(){Shiny.onInputChange(".clientValue-plotly_click-"+x.source,null)}),graphDiv.on("plotly_deselect",function(){Shiny.onInputChange(".clientValue-plotly_selected-"+x.source,null),Shiny.onInputChange(".clientValue-plotly_click-"+x.source,null)})),x.highlight.color=x.highlight.color||[],Array.isArray(x.highlight.color)||(x.highlight.color=[x.highlight.color]);for(var traceManager=new TraceManager(graphDiv,x.highlight),allSets=[],curveIdx=0;curveIdx<x.data.length;curveIdx++){var newSet=x.data[curveIdx].set;newSet&&-1===allSets.indexOf(newSet)&&allSets.push(newSet)}for(var i=0;i<allSets.length;i++){var set=allSets[i],selection=new crosstalk.SelectionHandle(set),filter=new crosstalk.FilterHandle(set),filterChange=function(e){removeBrush(el),traceManager.updateFilter(set,e.value)};filter.on("change",filterChange);var selectionChange=function(e){"plotly_selected"===x.highlight.on&&x.highlight.persistentShift&&(Array.prototype.diff=function(a){return this.filter(function(i){return a.indexOf(i)<0})},e.value=e.value.diff(e.oldValue));var selectionHistory=crosstalk["var"]("plotlySelectionHistory").get()||[],event={receiverID:traceManager.gd.id,plotlySelectionColour:crosstalk.group(set)["var"]("plotlySelectionColour").get()};if(event[set]=e.value,selectionHistory.length>0)for(var ev=JSON.stringify(event),i=0;i<selectionHistory.length;i++){var sel=JSON.stringify(selectionHistory[i]);if(sel==ev)return}x.highlight.persistent?selectionHistory.push(event):selectionHistory=[event],crosstalk["var"]("plotlySelectionHistory").set(selectionHistory),traceManager.updateSelection(set,e.value),x.selectize&&(x.highlight.persistent&&null!==e.value||selectize.clear(!0),selectize.addItems(e.value,!0),selectize.close())};if(selection.on("change",selectionChange),graphDiv.on(x.highlight.on,function(e){if(e){var selectedKeys=pointsToKeys(e.points);for(var set in selectedKeys)selectedKeys.hasOwnProperty(set)&&selection.set(selectedKeys[set].value,{sender:el})}}),graphDiv.on(x.highlight.off,function(){removeBrush(el),crosstalk["var"]("plotlySelectionHistory").set(null),selection.set(null,{sender:el})}),x.selectize){var selectizeID=Object.keys(x.selectize)[i],items=x.selectize[selectizeID].items,first=[{value:"",label:"(All)"}],opts={options:first.concat(items),searchField:"label",valueField:"value",labelField:"label",maxItems:50},select=$("#"+selectizeID).find("select")[0],selectize=$(select).selectize(opts)[0].selectize;selectize.on("change",function(){var currentItems=traceManager.groupSelections[set]||[];if(!x.highlight.persistent){removeBrush(el);for(var i=0;i<currentItems.length;i++)selectize.removeItem(currentItems[i],!0)}var newItems=selectize.items.filter(function(idx){return currentItems.indexOf(idx)<0});newItems.length>0?traceManager.updateSelection(set,newItems):(traceManager.updateSelection(set,null),traceManager.updateSelection(set,selectize.items))})}}}}),TraceManager.prototype.close=function(){},TraceManager.prototype.updateFilter=function(group,keys){if("undefined"==typeof keys||null===keys)this.gd.data=JSON.parse(JSON.stringify(this.origData));else for(var traces=[],i=0;i<this.origData.length;i++){var trace=this.origData[i];if(trace.key&&trace.set===group){var matchFunc=getMatchFunc(trace),matches=matchFunc(trace.key,keys);matches.length>0&&(trace._isSimpleKey||(trace=subsetArrayAttrs(trace,matches)),traces.push(trace))}}this.gd.data=traces,Plotly.redraw(this.gd)},TraceManager.prototype.updateSelection=function(group,keys){if(null!==keys&&!Array.isArray(keys))throw new Error("Invalid keys argument; null or array expected");var nNewTraces=this.gd.data.length-this.origData.length;if(null===keys||!this.highlight.persistent&&nNewTraces>0){for(var tracesToRemove=[],i=this.origData.length;i<this.gd.data.length;i++)tracesToRemove.push(i);Plotly.deleteTraces(this.gd,tracesToRemove),this.groupSelections[group]=keys}else{this.groupSelections[group]=this.groupSelections[group]||[];for(var i=0;i<keys.length;i++){var k=keys[i];this.groupSelections[group].indexOf(k)<0&&this.groupSelections[group].push(k)}}if(null===keys)Plotly.restyle(this.gd,{opacity:this.origOpacity});else if(keys.length>=1){for(var traces=[],selectionColour=crosstalk.group(group)["var"]("plotlySelectionColour").get()||this.highlight.color[0],i=0;i<this.origData.length;i++){var trace=JSON.parse(JSON.stringify(this.gd.data[i]));if(trace.key&&trace.set===group){var matchFunc=getMatchFunc(trace),matches=matchFunc(trace.key,keys);if(matches.length>0){trace._isSimpleKey||(trace=subsetArrayAttrs(trace,matches));var d=this.gd._fullData[i];$.extend(!0,trace,this.highlight.selected),d.marker&&(trace.marker=trace.marker||{},trace.marker.color=selectionColour||trace.marker.color||d.marker.color),d.line&&(trace.line=trace.line||{},trace.line.color=selectionColour||trace.line.color||d.line.color),d.textfont&&(trace.textfont=trace.textfont||{},trace.textfont.color=selectionColour||trace.textfont.color||d.textfont.color),d.fillcolor&&(trace.fillcolor=selectionColour||trace.fillcolor||d.fillcolor),trace.name=trace.name||keys.join("<br />"),trace.legendgroup=trace.legendgroup||keys.join("<br />"),trace._originalIndex=i,trace._newIndex=this.gd._fullData.length+traces.length,traces.push(trace)}}}if(traces.length>0){Plotly.addTraces(this.gd,traces).then(function(gd){for(var _hash=gd._transitionData._frameHash,_frames=gd._transitionData._frames||[],i=0;i<_frames.length;i++){for(var newIndices=[],j=0;j<traces.length;j++){var tr=traces[j];_frames[i].traces.indexOf(tr._originalIndex)>-1&&(newIndices.push(tr._newIndex),_frames[i].traces.push(tr._newIndex))}if(0!==newIndices.length){for(var ctr=0,nFrameTraces=_frames[i].data.length,j=0;nFrameTraces>j;j++){var frameTrace=_frames[i].data[j];if(frameTrace.key&&frameTrace.set===group){var matchFunc=getMatchFunc(frameTrace),matches=matchFunc(frameTrace.key,keys);if(matches.length>0){trace._isSimpleKey||(frameTrace=subsetArrayAttrs(frameTrace,matches));var d=gd._fullData[newIndices[ctr]];d.marker&&(frameTrace.marker=d.marker),d.line&&(frameTrace.line=d.line),d.textfont&&(frameTrace.textfont=d.textfont),ctr+=1,_frames[i].data.push(frameTrace)}}}_hash[_frames[i].name]=_frames[i]}}});for(var tracesToDim=[],opacities=[],sets=Object.keys(this.groupSelections),n=this.origData.length,i=0;n>i;i++){var opacity=this.origOpacity[i]||1;if(opacity===this.gd._fullData[i].opacity&&1!==this.highlight.opacityDim){var matches=findMatches(sets,[this.gd.data[i].set]);matches.length&&(tracesToDim.push(i),opacities.push(opacity*this.highlight.opacityDim))}}tracesToDim.length>0&&(Plotly.restyle(this.gd,{opacity:opacities},tracesToDim),Plotly.restyle(this.gd,{selectedpoints:null}))}}};
